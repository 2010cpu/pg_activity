Functional tests for 'ui' module
--------------------------------

>>> import functools
>>> import optparse
>>> from unittest.mock import patch

>>> import blessed
>>> from blessed.keyboard import Keystroke

>>> from pgactivity import ui

>>> postgres = getfixture("postgresql")

Default CLI options, passed to ui.main():
>>> defaults = {
...     "blocksize": 4096,
...     "dbname": f"{postgres.info.dbname}",
...     "debug": False,
...     "durationmode": "1",
...     "help": False,
...     "host": f"{postgres.info.host}",
...     "legacy_ui": False,
...     "minduration": 0,
...     "noappname": True,
...     "noclient": False,
...     "nocolor": False,
...     "nocpu": True,
...     "nodb": False,
...     "nodbsize": False,
...     "nomem": True,
...     "nopid": False,
...     "noread": True,
...     "notime": True,
...     "nouser": False,
...     "nowait": True,
...     "nowrite": True,
...     "output": None,
...     "port": f"{postgres.info.port}",
...     "rds": False,
...     "username": f"{postgres.info.user}",
...     "verbosemode": "2",
... }
>>> options = optparse.Values(defaults=defaults)

>>> def mk_inkey(keys):
...     def inkey(*args, **kwargs):
...         inkey.call_args_list.append((args, kwargs))
...         return Keystroke(keys.pop(0))
...     inkey.call_args_list = []
...     return inkey

>>> term = blessed.Terminal(force_styling=None)
>>> term.width, term.height
(80, 25)

>>> def run_ui(options, keys, expected_timeouts=None):
...     """Wrapper to ui.main() with a fake term.inkey()."""
...
...     call_args_list = []
...
...     def inkey(*, timeout):
...         call_args_list.append(timeout)
...         key = keys.pop(0)
...         print(term.center(f" sending key '{key}' ", fillchar="-"))
...         return Keystroke(key)
...
...     with patch.object(term, "inkey", new=inkey) as patched_inkey:
...         ui.main(options, term=term, render_footer=False)
...
...     if expected_timeouts is not None:
...         assert call_args_list == expected_timeouts

Mock system statistics
>>> get_mem_swap = patch(
...     "pgactivity.activities.get_mem_swap",
...     return_value=(1.2, 3_000_000, 4_000_000_000, 5.6, 7_000, 8_000_000_000),
... )
>>> get_load_average = patch(
...     "pgactivity.activities.get_load_average",
...     return_value=(0.12, 0.14, 0.1),
... )
>>> pg_get_db_info = patch(
...     "pgactivity.data.Data.pg_get_db_info",
...     return_value={"total_size": 111_222_333, "size_ev": 0,
...                   "tps": 0, "max_length": 27},
... )
>>> get_mem_swap.start()
<MagicMock name='get_mem_swap' id='...'>
>>> get_load_average.start()
<MagicMock name='get_load_average' id='...'>
>>> pg_get_db_info.start()
<MagicMock name='pg_get_db_info' id='...'>

No activity, first screen followed by help screen:

>>> run_ui(options, ["h", "z", "q"])  # doctest: +ELLIPSIS
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
PID    DATABASE                     USER           CLIENT  IOW              state   Query
------------------------------- sending key 'h' --------------------------------
pg_activity 1.6.2 - https://github.com/dalibo/pg_activity
Released under PostgreSQL License.
<BLANKLINE>
   Up/Down: scroll process list
         C: activate/deactivate colors
     Space: pause
         r: sort by READ/s desc. (activities)
         v: change display mode
         w: sort by WRITE/s desc. (activities)
         q: quit
         +: increase refresh time (max:5s)
         c: sort by CPU% desc. (activities)
         m: sort by MEM% desc. (activities)
         -: decrease refresh time (min:0.5s)
         t: sort by TIME+ desc. (activities)
         R: force refresh
         T: change duration mode
         D: force refresh database size
Mode
      F1/1: running queries
      F2/2: waiting queries
      F3/3: blocking queries
<BLANKLINE>
Press any key to exit.
------------------------------- sending key 'z' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
PID    DATABASE                     USER           CLIENT  IOW              state   Query
------------------------------- sending key 'q' --------------------------------


>>> defaults["nopid"] = True
>>> options = optparse.Values(defaults=defaults)

One query, idle in transaction:
>>> cur = postgres.cursor()
>>> cur.execute("SELECT pg_sleep(0)")
>>> cur.close()

Change refresh time, pause, change duration mode, change sort order, unpause,
change query mode then quit:

>>> keys = ["-", "-", "+", " ", "T", "c", " ", "2", "3", "1", "q"]
>>> expected_timeouts = [2.0, 1.0, 0.5, 1, 1, 1, 1, 1, 1, 1, 1]
>>> run_ui(options, keys, expected_timeouts=expected_timeouts)  # doctest: +ELLIPSIS
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key '-' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key '-' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 0.5s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key '+' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key ' ' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode:       query
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                     PAUSE                                      
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key 'T' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                     PAUSE                                      
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key 'c' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                     PAUSE                                      
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key ' ' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key '2' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                WAITING QUERIES
DATABASE                     USER           CLIENT  RELATION             TYPE             MODE              state   Query
------------------------------- sending key '3' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                BLOCKING QUERIES
DATABASE                     USER           CLIENT  RELATION             TYPE             MODE              state   Query
------------------------------- sending key '1' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 1s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE                     USER           CLIENT  IOW              state   Query
tests                    postgres     127.0.0.1/32    N      idle in trans   SELECT pg_sleep(0)
------------------------------- sending key 'q' --------------------------------


Another idle transaction, with a long query:
>>> cur = postgres.cursor()
>>> cur.execute("CREATE TABLE persons (firstname text, lastname text, age int, address text)")
>>> cur.close()

Use another set of options:
>>> output = getfixture("tmp_path") / "activities.csv"
>>> options = optparse.Values(
...     defaults=dict(
...         defaults,
...         durationmode="2",
...         verbosemode="3",
...         noclient=True,
...         nouser=True,
...         nodbsize=True,
...         output=str(output),
...     ),
... )
>>> run_ui(options, ["D", "v", "q"])  # doctest: +ELLIPSIS
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE          IOW              state   Query                                
tests               N      idle in trans   CREATE TABLE persons (firstname text,
                                           lastname text, age int, address text)
------------------------------- sending key 'D' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE          IOW              state   Query                                
tests               N      idle in trans   CREATE TABLE persons (firstname text,
                                           lastname text, age int, address text)
------------------------------- sending key 'v' --------------------------------
PostgreSQL ... - ... - postgres@127.0.0.1:.../tests - Ref.: 2.0s
 Size:       106.07M - 0B/s           | TPS:               0      | Active connections:               1      | Duration mode: transaction
 Mem.:       1.2% - 2.86M/3.73G       | IO Max:        0/s
 Swap:       5.6% - 6.84K/7.45G       | Read:           0B/s - 0/s
 Load:         0.12 0.14 0.10         | Write:          0B/s - 0/s
                                RUNNING QUERIES
DATABASE          IOW              state   Query                                
tests               N      idle in trans   CREATE TABLE persons (firstname text,
------------------------------- sending key 'q' --------------------------------
>>> with output.open() as f:
...     lines = f.readlines()
>>> len(lines)
4
